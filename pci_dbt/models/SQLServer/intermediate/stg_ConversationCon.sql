	{{ config(materialized='ephemeral') }}
	
SELECT 
			  t1.CONVERSATION_ID
			, t1.DIVISION_ID
			, CASE
				WHEN CHARINDEX(',', t1.DIVISION_ID) > 0 THEN RTRIM(LEFT(t1.DIVISION_ID, CHARINDEX(',', t1.DIVISION_ID) - 1))
				ELSE t1.DIVISION_ID END AS DIVISION_ID_2
			, MIN(DATEADD(HOUR,CONVERT(INT,gdt_sd.offset), t1.CONVERSATION_START))  AS CONVERSATION_START
			, MAX(DATEADD(HOUR,CONVERT(INT,gdt_ed.offset), t1.CONVERSATION_END)) AS CONVERSATION_END 
			, DATEDIFF(ss,MIN(t1.CONVERSATION_START),MAX(t1.CONVERSATION_END)) AS DURATION_SECONDS
			, UPPER(LEFT(t1.ORIGINATING_DIRECTION,1))+LOWER(SUBSTRING(t1.ORIGINATING_DIRECTION,2,LEN(t1.ORIGINATING_DIRECTION))) AS DIRECTION
			, IIF(t1.OUTBOUND_CAMPAIGN_ID IS NOT NULL,'Dialer','Manual') AS CALL_METHOD
			, MAX(t1.cvs_LocalizedFlag) AS LOCALIZED_FLAG	
			, ISNULL(t4.[NAME],'') AS CAMPAIGN_NAME
			, ISNULL(t4.DIALING_MODE,'') AS DIALING_MODE
			, ISNULL(CAST(t1.OUTBOUND_CONTACT_ID_OVERRIDE AS VARCHAR),OUTBOUND_CONTACT_ID) AS CONTACT_LIST_ID
			, ISNULL(SUM(t1.FLOW),0) AS FLOW
			, ISNULL(SUM(t1.OUTBOUND),0) AS OUTBOUND
			, ISNULL(SUM(t1.OUTBOUND_ATTEMPTED),0) AS CAMPAIGN_ATTEMPTED
			, ISNULL(SUM(t1.OUTBOUND_CONNECTED),0) AS CAMPAIGN_CONNECTED
			, ISNULL(SUM(t1.OUTBOUND_ABANDONED),0) AS CAMPAIGN_ABANDONED
			, ISNULL(SUM(t1.OFFERED),0) AS OFFERED
			, ISNULL(SUM(IIF(t1.ANSWERED_TIME IS NOT NULL,1,0)),0) AS ANSWERED
			, ISNULL(SUM(t1.CONNECTED),0) AS CONNECTED
			, ISNULL(SUM(t1.ERROR),0) AS ERROR
			, ISNULL(SUM(t1.OVER_SLA),0) AS OVER_SLA
			, ISNULL(SUM(t1.CONSULT),0) AS CONSULT
			, ISNULL(SUM(t1.TRANSFERRED),0) AS TRANSFERRED
			, ISNULL(SUM(t1.TRANSFERRED_CONSULT),0) AS TRANSFERRED_CONSULT
			, ISNULL(SUM(t1.TRANSFERRED_BLIND),0) AS TRANSFERRED_BLIND
			, ISNULL(SUM(t1.IVR_TIME),0) AS IVR_TIME
			, ISNULL(SUM(t1.ABANDON_TIME),0) AS ABANDON_TIME
			, ISNULL(SUM(t1.ACD_TIME),0) AS ACD_TIME
			, ISNULL(SUM(t1.ALERT_TIME),0) AS ALERT_TIME
			, ISNULL(SUM(t1.AGENT_RESPONSE_TIME),0) AS AGENT_RESPONSE_TIME
			, ISNULL(SUM(t1.CONTACTING_TIME),0) AS CONTACTING_TIME
			, ISNULL(SUM(t1.DIALING_TIME),0) AS DIALING_TIME
			, ISNULL(SUM(t1.FLOW_TIME),0) AS FLOW_TIME
			, ISNULL(SUM(t1.ANSWERED_TIME),0) AS ANSWERED_TIME
			, ISNULL(SUM(t1.TALK_TIME),0) AS TALK_TIME
			, ISNULL(SUM(t1.HELD_TIME),0) AS HELD_TIME
			, ISNULL(SUM(t1.ACW_TIME),0) AS ACW_TIME
			, ISNULL(SUM(t1.HANDLE_TIME),0) AS HANDLE_TIME
			, MIN(START_DATE_TIME_KEY) AS M_START_DATE_TIME_KEY
			, MAX(t1.LAST_MODIFIED) LAST_MODIFIED
			, MAX(t1.ZLOADDATE) ZLOADDATE
		FROM  {{ ref('stg_gc_conversation_segment_fact') }} t1 --End time is a requirement
  		INNER JOIN {{ ref('stg_gc_date_time') }}  gdt_sd ON t1.START_DATE_TIME_KEY = gdt_sd.DATE_TIME_KEY
  		INNER JOIN {{ ref('stg_gc_date_time') }}  gdt_ed ON t1.END_DATE_TIME_KEY = gdt_ed.DATE_TIME_KEY
		LEFT JOIN  {{ ref('stg_gc_outbound_campaigns') }} t4 ON t1.OUTBOUND_CAMPAIGN_ID = t4.CAMPAIGN_ID AND t1.CONVERSATION_START BETWEEN t4.EFFECTIVE_DATE AND t4.EXPIRATION_DATE
		GROUP BY 	
			  t1.CONVERSATION_ID
			, t1.DIVISION_ID
			, t1.ORIGINATING_DIRECTION
			, IIF(t1.OUTBOUND_CAMPAIGN_ID IS NOT NULL,'Dialer','Manual')
			, t4.[NAME]
			, t4.DIALING_MODE
			, ISNULL(CAST(t1.OUTBOUND_CONTACT_ID_OVERRIDE AS VARCHAR),OUTBOUND_CONTACT_ID)
